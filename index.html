<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parchment To-Do List</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'EB Garamond', serif;
            background-color: #111827; /* Tailwind gray-900 */
            color: #e5e7eb; /* Tailwind gray-200 */
        }
        .paper {
            background-color: #1f2937; /* Tailwind gray-800 */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            border-radius: 8px;
            border: 1px solid #374151; /* Tailwind gray-700 */
        }
        h1, .todo-text, .label-text {
             color: #e5e7eb; /* Tailwind gray-200 */
        }
        .todo-item {
            position: relative;
            transition: background-color 0.3s;
            border-bottom: 1px solid #374151; /* Subtle separator */
        }
        .todo-item:last-child {
            border-bottom: none;
        }
        /* Priority Backgrounds */
        .priority-high { background-color: #3d1f23 !important; }
        .priority-medium { background-color: #3e2f1e !important; }
        .priority-low { background-color: #1c2a3b !important; }

        .todo-item.drag-over {
            background-color: #374151 !important; /* Highlight when dragging over */
        }
        .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #6b7280; /* Tailwind gray-500 */
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }
        .completed .checkbox {
            background-color: #3b82f6; /* A nice blue for completed */
            border-color: #3b82f6;
        }
        .checkmark__path {
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            stroke: #ffffff; /* White checkmark */
            stroke-width: 3;
            transition: stroke-dashoffset 0.4s cubic-bezier(0.65, 0, 0.45, 1);
        }
        .completed .checkmark__path {
            stroke-dashoffset: 0;
        }
        .todo-text {
            outline: none;
            position: relative;
            font-size: 1.25rem;
            line-height: 1.5;
            transition: color 0.1s 0.3s;
        }
        .main-content::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #6b7280; /* Gray strikethrough */
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s cubic-bezier(0.65, 0, 0.45, 1);
            border-radius: 2px;
            pointer-events: none;
        }
        .completed .main-content::after {
            transform: scaleX(1);
        }
        .completed .todo-text, .completed .item-label {
            color: transparent !important;
            background-color: transparent !important;
            border-color: transparent !important;
        }
        .delete-btn {
            color: #9ca3af; /* Tailwind gray-400 */
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            padding: 0 0.5rem;
            opacity: 0;
            transition: opacity 0.2s, color 0.2s;
        }
        .todo-item:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { color: #ef4444; } /* Tailwind red-500 */

        .control-btn, .sort-btn {
            font-family: 'EB Garamond', serif;
            background-color: #374151; /* Tailwind gray-700 */
            border: 1px solid #4b5563; /* Tailwind gray-600 */
            color: #e5e7eb; /* Tailwind gray-200 */
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s, color 0.2s;
        }
        .control-btn:hover, .sort-btn:hover {
            background-color: #4b5563; /* Tailwind gray-600 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .sort-btn.active {
            background-color: #3b82f6; /* Accent blue */
            color: #ffffff;
            border-color: #3b82f6;
        }

        /* Label Manager & Tag Styles */
        .label-input {
            border: 1px solid #4b5563; /* Tailwind gray-600 */
            background-color: #1f2937; /* Tailwind gray-800 */
            outline-color: #3b82f6; /* Accent blue on focus */
            color: #e5e7eb;
        }
        .draggable-label {
            border: 1px solid rgba(255,255,255,0.1);
            cursor: grab;
            color: white;
            font-weight: 500;
        }
        .draggable-label:active { cursor: grabbing; }
        .delete-label-btn {
             color: rgba(255,255,255,0.7);
        }
        .delete-label-btn:hover {
             color: white;
        }
        .item-label {
            border: 1px solid rgba(0,0,0,0.1);
            font-size: 0.8rem;
            color: white;
            transition: color 0.1s 0.3s, background-color 0.1s 0.3s;
            position: relative;
            font-weight: 500;
        }
        .delete-item-label-btn {
            position: absolute;
            top: -5px;
            right: -1px;
            font-size: 14px;
            line-height: 1;
            font-weight: bold;
            color: rgba(255,255,255,0.5);
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .item-label:hover .delete-item-label-btn {
            opacity: 1;
        }
        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s, border-color 0.2s;
        }
        .color-swatch:hover {
            transform: scale(1.1);
        }
        .color-swatch.selected {
            border-color: #3b82f6; /* Accent blue */
        }
        .todo-column {
            background-color: rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 1rem;
        }
    </style>
</head>
<body class="bg-gray-900">

    <div class="flex flex-col xl:flex-row items-start justify-center w-full min-h-screen gap-8 p-4 sm:p-6 md:p-8">

        <!-- Main To-Do List -->
        <main class="paper w-full max-w-5xl p-6 sm:p-8">
            <header class="text-center mb-4">
                <h1 class="text-4xl sm:text-5xl font-medium tracking-wide">My To-Do List</h1>
            </header>

            <div class="flex justify-center items-center gap-2 mb-8">
                <span class="text-lg text-gray-400">View:</span>
                <button id="view-by-label-btn" class="sort-btn active">Label</button>
                <button id="view-by-priority-btn" class="sort-btn">Priority</button>
            </div>

            <div id="columns-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 auto-rows-fr gap-6">
                <!-- Dynamic columns will be inserted here -->
            </div>

            <div class="border-t border-gray-700 mt-8 pt-6 flex flex-col sm:flex-row items-center justify-end">
                <button id="new-list-btn" class="control-btn w-full sm:w-auto">Start New List</button>
            </div>
        </main>

        <!-- Label Manager -->
        <aside class="paper w-full xl:w-80 flex-shrink-0 p-6">
             <h2 class="text-2xl font-medium text-gray-200 mb-4 text-center xl:text-left">Priorities</h2>
            <div id="priority-labels" class="flex flex-wrap justify-center xl:justify-start gap-2 mb-6">
                <!-- Priority labels will be inserted here -->
            </div>

            <h2 class="text-2xl font-medium text-gray-200 mb-4 text-center xl:text-left">Custom Labels</h2>
            <div class="flex gap-2 mb-4">
                <input type="text" id="new-label-input" placeholder="New label..." class="label-input rounded-md px-2 py-1 w-full text-lg">
                <button id="add-label-btn" class="control-btn !px-3">+</button>
            </div>
            <div id="color-palette" class="flex flex-wrap justify-center gap-2 mb-4">
                <!-- Color swatches are added here by JS -->
            </div>
            <div id="label-cloud" class="flex flex-wrap gap-2">
                <!-- Draggable labels will be inserted here -->
            </div>
        </aside>

    </div>

    <script>
        const columnsContainer = document.getElementById('columns-container');
        const newListBtn = document.getElementById('new-list-btn');
        const newLabelInput = document.getElementById('new-label-input');
        const addLabelBtn = document.getElementById('add-label-btn');
        const labelCloud = document.getElementById('label-cloud');
        const colorPalette = document.getElementById('color-palette');
        const priorityLabelsContainer = document.getElementById('priority-labels');
        const viewByLabelBtn = document.getElementById('view-by-label-btn');
        const viewByPriorityBtn = document.getElementById('view-by-priority-btn');

        const TODO_STORAGE_KEY = 'persistentTodoList_v5';
        const LABELS_STORAGE_KEY = 'customTodoLabels_v4';
        const SORT_MODE_KEY = 'todoListSortMode_v1';
        const LABEL_COLORS = ['#f472b6', '#a78bfa', '#60a5fa', '#34d399', '#facc15', '#fb923c', '#e11d48', '#8b5cf6', '#22d3ee', '#4ade80', '#f97316', '#0ea5e9', '#d946ef', '#6366f1', '#10b981', '#f59e0b'];
        const PRIORITIES = {
            High: { color: '#ef4444', name: 'High' },
            Medium: { color: '#f97316', name: 'Medium' },
            Low: { color: '#3b82f6', name: 'Low' }
        };

        let currentSortMode = localStorage.getItem(SORT_MODE_KEY) || 'label';

        // --- CORE TODO FUNCTIONS ---
        function renderBoard() {
            const items = JSON.parse(localStorage.getItem(TODO_STORAGE_KEY)) || [];
            columnsContainer.innerHTML = '';

            if (currentSortMode === 'label') {
                const groupedByLabel = { 'Uncategorized': [] };
                const labelOrder = Array.from(labelCloud.querySelectorAll('.draggable-label .label-text')).map(span => span.textContent);
                labelOrder.forEach(label => { groupedByLabel[label] = []; });

                const priorityLabelNames = Object.values(PRIORITIES).map(p => p.name);

                items.forEach(item => {
                    const itemLabels = item.labels || [];
                    const nonPriorityLabels = itemLabels.filter(label => !priorityLabelNames.includes(label.text));

                    if (nonPriorityLabels.length === 0) {
                        groupedByLabel['Uncategorized'].push(item);
                    } else {
                        nonPriorityLabels.forEach(label => {
                            if (!groupedByLabel[label.text]) {
                                groupedByLabel[label.text] = [];
                            }
                            groupedByLabel[label.text].push(item);
                        });
                    }
                });

                const boardFragment = document.createDocumentFragment();
                const allLabelsInOrder = [...labelOrder, 'Uncategorized'];

                allLabelsInOrder.forEach(label => {
                    const itemsInGroup = groupedByLabel[label] || [];

                    // Don't render the 'Uncategorized' column if it's empty
                    if (label === 'Uncategorized' && itemsInGroup.length === 0) {
                        return;
                    }

                    const columnWrapper = document.createElement('div');
                    columnWrapper.className = 'todo-column flex flex-col gap-y-4';

                        const columnHeader = document.createElement('h3');
                        columnHeader.className = 'text-xl font-medium text-gray-300 text-center mb-2';
                        columnHeader.textContent = label;
                        columnWrapper.appendChild(columnHeader);

                        itemsInGroup.forEach(itemData => {
                            const itemEl = createTodoItem(itemData);
                            columnWrapper.appendChild(itemEl);
                        });
                        boardFragment.appendChild(columnWrapper);
                });
                columnsContainer.appendChild(boardFragment);

            } else {
                // --- Priority-Based View Logic ---
                const groupedByPriority = {
                    'High': [],
                    'Medium': [],
                    'Low': []
                };
                const priorityNames = Object.keys(PRIORITIES);

                items.forEach(item => {
                    let priority = 'Low'; // Default to Low
                    const priorityLabel = (item.labels || []).find(label => priorityNames.includes(label.text));
                    if (priorityLabel) {
                        priority = priorityLabel.text;
                    }
                    groupedByPriority[priority].push(item);
                });

                const boardFragment = document.createDocumentFragment();
                const priorityOrder = ['High', 'Medium', 'Low'];

                priorityOrder.forEach(priority => {
                    const itemsInGroup = groupedByPriority[priority];

                    const columnWrapper = document.createElement('div');
                    columnWrapper.className = 'todo-column flex flex-col gap-y-4';

                    const columnHeader = document.createElement('h3');
                    columnHeader.className = 'text-xl font-medium text-gray-300 text-center mb-2';
                    columnHeader.textContent = priority;
                    columnWrapper.appendChild(columnHeader);

                    if (itemsInGroup.length > 0) {
                        itemsInGroup.forEach(itemData => {
                            const itemEl = createTodoItem(itemData);
                            columnWrapper.appendChild(itemEl);
                        });
                    }
                    boardFragment.appendChild(columnWrapper);
                });
                columnsContainer.appendChild(boardFragment);
            }
        }

        function renderItemLabel(labelData, isPriority = false) {
            const itemLabel = document.createElement('div');
            itemLabel.className = 'item-label inline-block px-2 py-0.5 rounded-full';
            itemLabel.textContent = labelData.text;
            itemLabel.style.backgroundColor = labelData.color;
            itemLabel.dataset.text = labelData.text;
            if(isPriority) {
                itemLabel.classList.add('priority-tag');
            }

            const deleteTagBtn = document.createElement('span');
            deleteTagBtn.className = 'delete-item-label-btn';
            deleteTagBtn.innerHTML = '&times;';
            itemLabel.appendChild(deleteTagBtn);

            return itemLabel;
        }

        function applyPriorityBackground(itemEl, priorityName) {
            itemEl.classList.remove('priority-high', 'priority-medium', 'priority-low');
            if (priorityName) {
                itemEl.classList.add(`priority-${priorityName.toLowerCase()}`);
            }
        }

        function createTodoItem({ id = Date.now(), text = '', isCompleted = false, labels = [] } = {}) {
            const todoItem = document.createElement('div');
            todoItem.id = `item-${id}`;
            todoItem.className = 'todo-item flex items-center space-x-4 p-2 rounded-lg';
            if (isCompleted) todoItem.classList.add('completed');

            const checkbox = document.createElement('div');
            checkbox.className = 'checkbox flex items-center justify-center';
            checkbox.innerHTML = `<svg class="checkmark w-full h-full" viewBox="0 0 24 24"><path class="checkmark__path" d="M6 12l4 4 8-8" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

            const mainContent = document.createElement('div');
            mainContent.className = 'main-content flex-grow relative';

            const todoText = document.createElement('div');
            todoText.className = 'todo-text w-full';
            todoText.setAttribute('contenteditable', 'true');
            todoText.setAttribute('spellcheck', 'false');
            todoText.textContent = text;
            mainContent.appendChild(todoText);

            const labelsContainer = document.createElement('div');
            labelsContainer.className = 'labels-container flex flex-wrap gap-2 mt-1';
            mainContent.appendChild(labelsContainer);

            let priorityName = null;
            labels.forEach(labelData => {
                 const isPriority = Object.values(PRIORITIES).some(p => p.name === labelData.text);
                 if (isPriority) priorityName = labelData.text;
                 labelsContainer.appendChild(renderItemLabel(labelData, isPriority));
            });
            applyPriorityBackground(todoItem, priorityName);


            const deleteBtn = document.createElement('div');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '&times;';

            todoItem.appendChild(checkbox);
            todoItem.appendChild(mainContent);
            todoItem.appendChild(deleteBtn);

            todoItem.addEventListener('dragover', e => { e.preventDefault(); todoItem.classList.add('drag-over'); });
            todoItem.addEventListener('dragleave', () => todoItem.classList.remove('drag-over'));
            todoItem.addEventListener('drop', e => {
                e.preventDefault();
                todoItem.classList.remove('drag-over');
                try {
                    const droppedLabelData = JSON.parse(e.dataTransfer.getData('application/json'));
                    const itemId = todoItem.id.replace('item-', '');

                    saveList(); // Save any pending text edits first
                    const items = JSON.parse(localStorage.getItem(TODO_STORAGE_KEY)) || [];
                    const itemToUpdate = items.find(item => item.id === itemId);

                    if (itemToUpdate) {
                        if (droppedLabelData.isPriority) {
                            // Remove existing priority label from the data
                            const priorityNames = Object.values(PRIORITIES).map(p => p.name);
                            itemToUpdate.labels = itemToUpdate.labels.filter(label => !priorityNames.includes(label.text));
                        }

                        // Add the new label if it doesn't already exist
                        const exists = (itemToUpdate.labels || []).some(label => label.text === droppedLabelData.text);
                        if (!exists) {
                            itemToUpdate.labels.push({ text: droppedLabelData.text, color: droppedLabelData.color });
                        }

                        localStorage.setItem(TODO_STORAGE_KEY, JSON.stringify(items));
                        renderBoard();
                    }
                } catch (error) { console.error("Failed to parse drop data:", error); }
            });

            return todoItem;
        }

        function saveList() {
            const items = [];
            document.querySelectorAll('.todo-item').forEach(itemEl => {
                const textContent = itemEl.querySelector('.todo-text').textContent.trim();
                if (document.querySelectorAll('.todo-item').length === 1 && textContent === '') return;

                const labels = [];
                itemEl.querySelectorAll('.item-label').forEach(labelEl => {
                    labels.push({ text: labelEl.dataset.text, color: labelEl.style.backgroundColor });
                });

                items.push({
                    id: itemEl.id.replace('item-', ''),
                    text: itemEl.querySelector('.todo-text').textContent,
                    isCompleted: itemEl.classList.contains('completed'),
                    labels: labels
                });
            });
            localStorage.setItem(TODO_STORAGE_KEY, JSON.stringify(items));
        }

        function loadList() {
            // The loading logic is now inside renderBoard.
            // We just need to call it.
            renderBoard();
        }

        // --- LABEL & PRIORITY FUNCTIONS ---
        function createDraggableLabel({ text, color, isPriority = false, isDeletable = true }) {
            const labelEl = document.createElement('div');
            labelEl.className = 'draggable-label flex items-center gap-1 rounded-md px-2 py-1 text-lg';
            labelEl.setAttribute('draggable', 'true');
            labelEl.style.backgroundColor = color;

            const labelTextSpan = document.createElement('span');
            labelTextSpan.className = 'label-text';
            labelTextSpan.textContent = text;
            labelEl.appendChild(labelTextSpan);

            if (isDeletable) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-label-btn text-xs font-bold';
                deleteBtn.innerHTML = '&times;';
                labelEl.appendChild(deleteBtn);
                deleteBtn.addEventListener('click', () => {
                    const labelTextToRemove = labelEl.querySelector('.label-text').textContent;

                    // Remove the label from the cloud
                    labelEl.remove();
                    saveLabels();

                    // Remove the label from all todo items
                    saveList(); // Persist any pending text edits first
                    const items = JSON.parse(localStorage.getItem(TODO_STORAGE_KEY)) || [];
                    items.forEach(item => {
                        item.labels = (item.labels || []).filter(label => label.text !== labelTextToRemove);
                    });
                    localStorage.setItem(TODO_STORAGE_KEY, JSON.stringify(items));

                    // Re-render the board
                    renderBoard();
                });
            }

            labelEl.addEventListener('dragstart', e => {
                const data = JSON.stringify({ text, color, isPriority });
                e.dataTransfer.setData('application/json', data);
            });

            return labelEl;
        }

        function saveLabels() {
            const labels = [];
            labelCloud.querySelectorAll('.draggable-label').forEach(labelEl => {
                labels.push({
                    text: labelEl.querySelector('.label-text').textContent,
                    color: labelEl.style.backgroundColor
                });
            });
            localStorage.setItem(LABELS_STORAGE_KEY, JSON.stringify(labels));
        }

        function loadLabels() {
            labelCloud.innerHTML = '';
            const labels = JSON.parse(localStorage.getItem(LABELS_STORAGE_KEY)) || [];
            if (labels.length === 0) { // Default labels
                 labelCloud.appendChild(createDraggableLabel({text: 'Urgent', color: LABEL_COLORS[0]}));
                 labelCloud.appendChild(createDraggableLabel({text: 'Work', color: LABEL_COLORS[1]}));
                 saveLabels();
            } else {
                 labels.forEach(l => labelCloud.appendChild(createDraggableLabel(l)));
            }
        }

        function initializeColorPalette() {
            LABEL_COLORS.forEach((color, index) => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color;
                swatch.dataset.color = color;
                if (index === 0) swatch.classList.add('selected');
                colorPalette.appendChild(swatch);
            });

            colorPalette.addEventListener('click', e => {
                if (e.target.classList.contains('color-swatch')) {
                    colorPalette.querySelectorAll('.color-swatch').forEach(sw => sw.classList.remove('selected'));
                    e.target.classList.add('selected');
                }
            });
        }

        function initializePriorities() {
            Object.values(PRIORITIES).forEach(p => {
                priorityLabelsContainer.appendChild(createDraggableLabel({ text: p.name, color: p.color, isPriority: true, isDeletable: false }));
            });
        }

        // --- EVENT HANDLERS ---
        function handleAddLabel() {
            const labelText = newLabelInput.value.trim();
            if (labelText) {
                const selectedSwatch = colorPalette.querySelector('.color-swatch.selected');
                const newColor = selectedSwatch ? selectedSwatch.dataset.color : LABEL_COLORS[0];
                labelCloud.appendChild(createDraggableLabel({ text: labelText, color: newColor }));
                saveLabels();
                renderBoard();
                newLabelInput.value = '';
                newLabelInput.focus();
            }
        }

        function handleListClick(e) {
            const itemEl = e.target.closest('.todo-item');
            if (!itemEl) return;

            if (e.target.closest('.checkbox')) {
                itemEl.classList.toggle('completed');
                saveList();
            } else if (e.target.closest('.delete-btn')) {
                const itemId = itemEl.id.replace('item-', '');
                const items = JSON.parse(localStorage.getItem(TODO_STORAGE_KEY)) || [];
                const filteredItems = items.filter(item => item.id !== itemId);
                localStorage.setItem(TODO_STORAGE_KEY, JSON.stringify(filteredItems));
                renderBoard();
            } else if (e.target.classList.contains('delete-item-label-btn')) {
                const labelTextToRemove = e.target.closest('.item-label').dataset.text;
                const itemId = itemEl.id.replace('item-', '');

                saveList(); // Save any pending text edits first
                const items = JSON.parse(localStorage.getItem(TODO_STORAGE_KEY)) || [];
                const itemToUpdate = items.find(item => item.id === itemId);

                if (itemToUpdate) {
                    itemToUpdate.labels = (itemToUpdate.labels || []).filter(label => label.text !== labelTextToRemove);
                    localStorage.setItem(TODO_STORAGE_KEY, JSON.stringify(items));
                    renderBoard();
                }
            }
        }

        function handleListKeyDown(e) {
            if (e.target.classList.contains('todo-text') && e.key === 'Enter') {
                e.preventDefault();
                saveList(); // Save any edits in the current item
                const items = JSON.parse(localStorage.getItem(TODO_STORAGE_KEY)) || [];
                if (items.length < 20) {
                    const newItemId = Date.now();
                    items.push({ id: newItemId, text: '', isCompleted: false, labels: [] });
                    localStorage.setItem(TODO_STORAGE_KEY, JSON.stringify(items));
                    renderBoard();

                    const newItemEl = document.getElementById(`item-${newItemId}`);
                    if (newItemEl) {
                        newItemEl.querySelector('.todo-text').focus();
                    }
                }
            }
        }

        function handleStartNewList() {
            // First, ensure the latest state is saved from the DOM.
            saveList();
            const items = JSON.parse(localStorage.getItem(TODO_STORAGE_KEY)) || [];

            const unfinishedItems = items.filter(item => !item.isCompleted && item.text.trim() !== '');

            localStorage.setItem(TODO_STORAGE_KEY, JSON.stringify(unfinishedItems));
            renderBoard();
        }

        function setSortMode(mode) {
            currentSortMode = mode;
            localStorage.setItem(SORT_MODE_KEY, mode);
            viewByLabelBtn.classList.toggle('active', mode === 'label');
            viewByPriorityBtn.classList.toggle('active', mode === 'priority');
            renderBoard();
        }

        // --- INITIALIZATION ---
        document.addEventListener('click', handleListClick);
        document.addEventListener('input', e => { if (e.target.classList.contains('todo-text')) saveList(); });
        document.addEventListener('keydown', handleListKeyDown);

        newListBtn.addEventListener('click', handleStartNewList);
        addLabelBtn.addEventListener('click', handleAddLabel);
        newLabelInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleAddLabel(); });

        viewByLabelBtn.addEventListener('click', () => setSortMode('label'));
        viewByPriorityBtn.addEventListener('click', () => setSortMode('priority'));

        initializeColorPalette();
        initializePriorities();
        loadLabels();
        loadList();
        setSortMode(currentSortMode); // Apply initial sort mode
    </script>
</body>
</html>
